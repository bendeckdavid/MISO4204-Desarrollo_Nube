# Docker Compose simulating ECS Fargate deployment with LocalStack
# This configuration mimics the ECS Fargate architecture using local containers

version: '3.8'

services:
  db:
    image: postgres:16-alpine
    container_name: fargate_db
    environment:
      POSTGRES_USER: fastapi_user
      POSTGRES_PASSWORD: fastapi_password
      POSTGRES_DB: fastapi_db
    command: postgres -c max_connections=300 -c shared_buffers=256MB -c effective_cache_size=1GB
    volumes:
      - fargate_postgres_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fastapi_user -d fastapi_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fargate_network

  localstack:
    image: localstack/localstack:latest
    container_name: fargate_localstack
    environment:
      - SERVICES=s3,sqs
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    ports:
      - "4567:4566"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fargate_network

  # Web Service (simulating ECS Fargate web tasks)
  web:
    image: anb-web:latest
    container_name: fargate_web_1
    environment:
      - DATABASE_URL=postgresql://fastapi_user:fastapi_password@db:5432/fastapi_db
      - SECRET_KEY=your-secret-key-change-in-production-at-least-32-characters-long
      - STORAGE_BACKEND=s3
      - AWS_S3_BUCKET=anb-videos-dev
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
      - SQS_QUEUE_URL=http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/video-processing-queue
      - SQS_DLQ_URL=http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/video-processing-dlq
      - ENVIRONMENT=production
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    ports:
      - "8001:8000"
    networks:
      - fargate_network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1024M
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/health', timeout=2)"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3

  # Second web instance for load balancing simulation
  web-2:
    image: anb-web:latest
    container_name: fargate_web_2
    environment:
      - DATABASE_URL=postgresql://fastapi_user:fastapi_password@db:5432/fastapi_db
      - SECRET_KEY=your-secret-key-change-in-production-at-least-32-characters-long
      - STORAGE_BACKEND=s3
      - AWS_S3_BUCKET=anb-videos-dev
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
      - SQS_QUEUE_URL=http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/video-processing-queue
      - SQS_DLQ_URL=http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/video-processing-dlq
      - ENVIRONMENT=production
    depends_on:
      db:
        condition: service_healthy
      localstack:
        condition: service_healthy
    ports:
      - "8002:8000"
    networks:
      - fargate_network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1024M

  # Worker Service (simulating ECS Fargate worker tasks)
  worker:
    image: anb-worker:latest
    container_name: fargate_worker_1
    environment:
      - DATABASE_URL=postgresql://fastapi_user:fastapi_password@db:5432/fastapi_db
      - STORAGE_BACKEND=s3
      - AWS_S3_BUCKET=anb-videos-dev
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_ENDPOINT_URL=http://localstack:4566
      - SQS_QUEUE_URL=http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/video-processing-queue
      - SQS_DLQ_URL=http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/video-processing-dlq
      - SECRET_KEY=your-secret-key-change-in-production-at-least-32-characters-long
    depends_on:
      - localstack
      - db
    networks:
      - fargate_network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 3072M

  # Load Balancer simulation (nginx)
  alb:
    image: nginx:alpine
    container_name: fargate_alb
    volumes:
      - ./nginx.fargate.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8090:80"
    depends_on:
      - web
      - web-2
    networks:
      - fargate_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  fargate_postgres_data:

networks:
  fargate_network:
    driver: bridge
